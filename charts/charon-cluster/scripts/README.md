# DKG Sidecar TypeScript Implementation

This directory contains the TypeScript implementation (`dkg-sidecar.ts`) of the DKG sidecar that orchestrates the distributed key generation process for Charon clusters.

## Overview

The DKG sidecar is an init container that runs before the main Charon node starts. It:
1. Reads the node's ENR (Ethereum Node Record) generated by the ENR job
2. Polls the Obol API for cluster definitions where this operator is invited
3. Accepts terms and conditions if needed
4. Monitors the cluster definition until all operators have signed
5. Initiates the DKG process once the definition is fully signed
6. Saves the resulting cluster-lock.json for the main Charon node to use

## TypeScript Implementation

The TypeScript version provides:
- Integration with the Obol SDK for API interactions
- Robust error handling and retry logic with exponential backoff
- Support for accepting cluster definitions
- Detailed logging for debugging
- Type safety and better maintainability

### Building

To build the TypeScript version locally:

```bash
cd scripts
npm install
npm run build
```

This will compile `dkg-sidecar.ts` to `dkg-sidecar.js`.

### Docker Image

The TypeScript sidecar runs in a custom Docker image based on Node.js. The Dockerfile is located at `../dkg-sidecar/Dockerfile`.

To build the Docker image:

```bash
cd ../dkg-sidecar
docker build -t charon-dkg-sidecar:latest .
```

The image uses a multi-stage build to:
1. Compile TypeScript to JavaScript
2. Install production dependencies only
3. Create a minimal runtime image

### Usage

The sidecar is configured in the Helm chart's StatefulSet as an init container:

```yaml
initContainers:
  - name: dkg-sidecar
    image: charon-dkg-sidecar:latest
    command:
      - "node"
      - "/app/dkg-sidecar.js"
      - "{{ .Values.charon.operatorAddress }}"
      - "/enr-from-job/enr.txt"
```

### Environment Variables

The TypeScript implementation supports the following environment variables:

- `OPERATOR_ADDRESS`: The operator's Ethereum address (required, passed as first argument)
- `ENR_FILE_PATH`: Path to the ENR file (required, passed as second argument)
- `OUTPUT_DEFINITION_FILE`: Path to save the cluster definition (default: `/charon-data/cluster-definition.json`)
- `API_ENDPOINT`: Obol API endpoint (default: `https://api.obol.tech`)
- `INITIAL_RETRY_INTERVAL_SECONDS`: Initial retry delay in seconds (default: `10`)
- `MAX_RETRY_INTERVAL_SECONDS`: Maximum retry delay in seconds (default: `300`)
- `BACKOFF_FACTOR`: Exponential backoff factor (default: `2`)
- `PAGE_LIMIT`: API pagination limit (default: `10`)
- `POD_NAME`: Kubernetes pod name (automatically set)
- `POD_NAMESPACE`: Kubernetes namespace (automatically set)

### API Polling Logic

The sidecar implements intelligent polling with exponential backoff:

1. Starts with `INITIAL_RETRY_INTERVAL_SECONDS` delay between polls
2. Increases delay by `BACKOFF_FACTOR` after each cycle (up to `MAX_RETRY_INTERVAL_SECONDS`)
3. Resets delay to initial value when new cluster definitions are found
4. Continues polling until a fully signed definition is found

### Cluster Definition Processing

When polling the API, the sidecar:
1. Fetches all cluster definitions for the operator
2. Filters for definitions where this node's ENR is included
3. Checks if all operators have signed their ENRs and configs
4. Accepts the definition if not already accepted
5. Waits for full signature completion
6. Saves the fully signed definition and initiates DKG

### Error Handling

The sidecar handles various error scenarios:
- API connection failures: Retries with backoff
- Invalid cluster definitions: Logs error and continues polling
- DKG process failures: Removes invalid definition and retries
- Missing ENR file: Waits for file to be created

### Development

For local development:

```bash
# Install dependencies
npm install

# Run TypeScript directly (for development)
npm run dev -- <operator-address> <enr-file-path>

# Build for production
npm run build

# Run tests (if available)
npm test
```

### Dependencies

Key dependencies:
- `@obolnetwork/sdk`: Official Obol SDK for API interactions
- `ethers`: Ethereum library for cryptographic operations
- `node-fetch`: HTTP client for API requests
- TypeScript and build tools for development

See `package.json` for the complete dependency list.