{{- if .Values.tests.dkgSidecar.enabled -}}
# This file defines the Deployment and Service for the DKG Mock API server,
# used during Helm tests for the DKG sidecar in various states.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-dkg-mock-api
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: test-dkg-mock-api
    {{- include "charon.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-5" # Ensure this runs before tests that depend on it
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: dkg-mock-api
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/name: charon-cluster # Match service selector
  template:
    metadata:
      labels:
        app.kubernetes.io/component: dkg-mock-api
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/name: charon-cluster # Match service selector
        {{- include "charon.labels" . | nindent 8 }}
    spec:
      {{- if .Values.tests.dkgSidecar.serviceAccount.create }}
      serviceAccountName: {{ template "charon.serviceAccountNameTest" . }}
      {{- end }}
      containers:
        - name: dkg-mock-api
          image: "dkg-mock-api:latest" # Assuming this image is available in your K8s environment
          imagePullPolicy: {{ .Values.tests.dkgSidecar.mockApi.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - name: http-mock
              containerPort: {{ .Values.tests.dkgSidecar.mockApi.port }}
              protocol: TCP
          env:
            - name: PORT
              value: {{ .Values.tests.dkgSidecar.mockApi.port | quote }}
            - name: MOCK_DKG_STATE
              value: "FULLY_SIGNED" # For this specific test scenario, can be parameterized if needed
          readinessProbe:
            httpGet:
              path: /v1/definition/operator/0x0000000000000000000000000000000000000000 # A generic health/readiness check endpoint
              port: http-mock
            initialDelaySeconds: 3
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 3
            successThreshold: 1
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-dkg-mock-api-service
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/component: test-dkg-mock-api-service
    {{- include "charon.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-5" # Ensure this runs before tests that depend on it
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/component: dkg-mock-api # Must match Deployment's template labels
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/name: charon-cluster
  ports:
    - port: {{ .Values.tests.dkgSidecar.mockApi.port }}
      targetPort: http-mock
      protocol: TCP
      name: http
{{- end }}
