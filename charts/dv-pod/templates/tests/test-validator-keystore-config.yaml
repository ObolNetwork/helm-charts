{{- if .Values.tests.validatorKeystore.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "dv-pod.fullname" . }}-test-vc-keystore
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "dv-pod.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    test-scenario: validator-keystore-config
spec:
  restartPolicy: Never
  initContainers:
    # Generate real keystores using Charon
    - name: generate-keystores
      image: obolnetwork/charon:v1.7.0
      command: ["charon", "create", "cluster",
                "--cluster-dir=/charon-output",
                "--num-validators={{ .Values.tests.validatorKeystore.mockKeystoreCount }}",
                "--nodes=3", "--network=holesky",
                "--withdrawal-addresses=0x0000000000000000000000000000000000000000",
                "--fee-recipient-addresses=0x0000000000000000000000000000000000000000",
                "--insecure-keys"]
      volumeMounts:
        - name: charon-data
          mountPath: /charon-output

    # Prepare validator data directory with correct ownership
    # This matches statefulset.yaml's prepare-validator-data init container
    - name: prepare-validator-data
      image: busybox:1.37.0
      securityContext:
        runAsUser: 0
        runAsGroup: 0
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Preparing validator data directory..."
          mkdir -p /validator-data
          chown -R 1000:1000 /validator-data
          echo "Directory prepared with correct ownership"
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data

    # ⚠️  MAINTAINER WARNING: This init container MUST mirror the production logic from:
    #     charts/dv-pod/templates/statefulset.yaml (import-keystores init container, lines ~158-336)
    #
    # WHY: This test validates the ACTUAL production keystore import logic used in statefulset.yaml.
    #      The entire case statement and all validator client implementations must stay synchronized.
    #
    # WHAT TO SYNC: The complete shell script logic inside the args section, including:
    #               - All case statement branches (lodestar, prysm, lighthouse, etc.)
    #               - Directory structures, file operations, and permissions
    #               - Error handling and validation logic
    #
    # WHEN UPDATING: ANY changes to the import-keystores init container in statefulset.yaml
    #                MUST be replicated here to ensure tests validate real production behavior.
    #
    # SOURCE OF TRUTH: charts/dv-pod/templates/statefulset.yaml (import-keystores init container)
    #
    - name: import-keystores
      image: busybox:1.37.0
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "Starting keystore import process..."

          # Determine validator client type
          VC_TYPE="{{ .Values.tests.validatorKeystore.validatorClientType }}"
          echo "Validator client type: $VC_TYPE"

          # Check if keystores already exist in validator-data
          if [ "$VC_TYPE" = "lodestar" ] && [ -d /validator-data/keystores ] && [ -d /validator-data/secrets ] && [ "$(ls -A /validator-data/keystores 2>/dev/null)" ]; then
            echo "Lodestar keystores and secrets already exist, skipping import"
            exit 0
          elif [ "$VC_TYPE" = "prysm" ] && [ -d /validator-data/wallet ] && [ -f /validator-data/wallet/direct/accounts/all-accounts.keystore.json ]; then
            echo "Wallet already exists, skipping import"
            exit 0
          elif [ "$VC_TYPE" = "nimbus" ] && [ -d /validator-data/validators ] && [ "$(ls -A /validator-data/validators 2>/dev/null)" ]; then
            echo "Keystores already exist in validator data, skipping import"
            exit 0
          fi

          # Determine source of keystores (for tests, always from charon DKG output)
          KEYSTORE_DIR="/charon-output/node0/validator_keys"

          if [ ! -d "$KEYSTORE_DIR" ] || [ ! "$(ls -A $KEYSTORE_DIR 2>/dev/null)" ]; then
            echo "ERROR: No keystores found in $KEYSTORE_DIR"
            exit 1
          fi

          echo "Importing keystores from: $KEYSTORE_DIR"

          # Import based on validator client type
          case "$VC_TYPE" in
            "lodestar")
              echo "Importing for Lodestar (persisted keys backend)..."
              mkdir -p /validator-data/keystores /validator-data/secrets

              # Create nested structure with per-keystore passwords
              IMPORTED_COUNT=0
              for f in $KEYSTORE_DIR/keystore-*.json; do
                if [ ! -f "$f" ]; then
                  echo "No keystore files found"
                  continue
                fi

                echo "Processing keystore: $f"

                # Extract pubkey from keystore JSON
                PUBKEY="0x$(grep '"pubkey"' "$f" | awk -F'"' '{print $4}')"

                if [ -z "$PUBKEY" ] || [ "$PUBKEY" = "0x" ]; then
                  echo "ERROR: Could not extract pubkey from $f"
                  continue
                fi

                # Create nested directory structure (one directory per validator pubkey)
                PUBKEY_DIR="/validator-data/keystores/$PUBKEY"
                mkdir -p "$PUBKEY_DIR"

                # Copy keystore with Lodestar's expected filename
                cp "$f" "$PUBKEY_DIR/voting-keystore.json"
                chmod 400 "$PUBKEY_DIR/voting-keystore.json"

                # Copy corresponding password file, named by pubkey
                PASSWORD_FILE="${f%.json}.txt"
                if [ -f "$PASSWORD_FILE" ]; then
                  cp "$PASSWORD_FILE" "/validator-data/secrets/$PUBKEY"
                  chmod 600 "/validator-data/secrets/$PUBKEY"
                  IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
                  echo "Imported keystore for pubkey: $PUBKEY"
                else
                  echo "ERROR: Password file not found: $PASSWORD_FILE"
                  exit 1
                fi
              done

              echo "Lodestar keystore import completed: imported=$IMPORTED_COUNT keystores"
              ;;
            "prysm")
              echo "Importing for Prysm..."

              # Just copy keystores to temporary location for now
              # The actual import will be done in a separate Prysm init container
              mkdir -p /validator-data/keystore-source
              cp -v $KEYSTORE_DIR/keystore-*.json /validator-data/keystore-source/ 2>/dev/null || echo "No keystore JSON files found"
              cp -v $KEYSTORE_DIR/keystore-*.txt /validator-data/keystore-source/ 2>/dev/null || echo "No keystore password files found"
              chmod -R 400 /validator-data/keystore-source/*.json 2>/dev/null || true
              chmod -R 600 /validator-data/keystore-source/*.txt 2>/dev/null || true

              echo "Keystores copied. Prysm wallet creation and import will be done in next init container"
              ;;
            "nimbus")
              echo "Importing for Nimbus..."

              # Just copy keystores to temporary location for now
              # The actual import will be done in a separate Nimbus init container
              mkdir -p /validator-data/keystore-source
              cp -v $KEYSTORE_DIR/keystore-*.json /validator-data/keystore-source/ 2>/dev/null || echo "No keystore JSON files found"
              cp -v $KEYSTORE_DIR/keystore-*.txt /validator-data/keystore-source/ 2>/dev/null || echo "No keystore password files found"
              chmod -R 400 /validator-data/keystore-source/*.json 2>/dev/null || true
              chmod -R 600 /validator-data/keystore-source/*.txt 2>/dev/null || true

              echo "Keystores copied. Nimbus import will be done in next init container"
              ;;
            *)
              echo "ERROR: Unknown validator client type: $VC_TYPE"
              exit 1
              ;;
          esac

          echo "Keystore import completed successfully"
      volumeMounts:
        - name: charon-data
          mountPath: /charon-output
          readOnly: true
        - name: validator-data
          mountPath: /validator-data

    # Prysm wallet creation and import (only runs for Prysm tests)
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "prysm" }}
    - name: prysm-wallet-import
      image: {{ .Values.validatorClient.image.repository | default "gcr.io/prysmaticlabs/prysm/validator" }}:{{ .Values.validatorClient.image.tag | default "v6.1.2" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "=== Prysm Test: Wallet Creation and Keystore Import ==="

          # Generate wallet password
          WALLET_PASSWORD="test-wallet-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)"
          echo "$WALLET_PASSWORD" > /validator-data/wallet-password.txt
          chmod 600 /validator-data/wallet-password.txt

          echo "Creating Prysm wallet..."
          /app/cmd/validator/validator wallet create \
            --wallet-dir=/validator-data/wallet \
            --wallet-password-file=/validator-data/wallet-password.txt \
            --keymanager-kind=direct \
            --accept-terms-of-use

          echo "Wallet created successfully"

          # Import keystores one at a time
          mkdir -p /tmp/tmpkeys
          IMPORTED_COUNT=0
          for keystore_file in /validator-data/keystore-source/keystore-*.json; do
            [ -f "$keystore_file" ] || continue

            echo "Importing keystore: $(basename $keystore_file)"
            cp "$keystore_file" /tmp/tmpkeys/

            password_file="${keystore_file%.json}.txt"
            if [ ! -f "$password_file" ]; then
              echo "ERROR: Password file not found: $password_file"
              exit 1
            fi

            /app/cmd/validator/validator accounts import \
              --wallet-dir=/validator-data/wallet \
              --keys-dir=/tmp/tmpkeys \
              --account-password-file="$password_file" \
              --wallet-password-file=/validator-data/wallet-password.txt \
              --accept-terms-of-use

            rm /tmp/tmpkeys/$(basename "$keystore_file")
            IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
            echo "Successfully imported $(basename $keystore_file)"
          done

          rm -rf /tmp/tmpkeys
          echo "=== Prysm test import completed: $IMPORTED_COUNT keystores imported ==="
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

    # Nimbus wallet creation and import (only runs for Nimbus tests)
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "nimbus" }}
    - name: nimbus-import
      image: {{ .Values.validatorClient.image.repository | default "statusim/nimbus-eth2" }}:{{ .Values.validatorClient.image.tag | default "multiarch-v25.9.2" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "=== Nimbus Test: Keystore Import ==="

          # Create temporary directory for import
          tmpkeys="/tmp/tmpkeys"
          mkdir -p "$tmpkeys"

          # Import keystores one at a time with per-keystore passwords
          IMPORTED_COUNT=0
          for keystore_file in /validator-data/keystore-source/keystore-*.json; do
            [ -f "$keystore_file" ] || continue

            filename=$(basename "$keystore_file")
            echo "Importing keystore: $filename"

            # Get corresponding password file
            password_file="${keystore_file%.json}.txt"
            if [ ! -f "$password_file" ]; then
              echo "ERROR: Password file not found: $password_file"
              exit 1
            fi

            # Read password
            password=$(cat "$password_file")

            # Copy keystore to temporary directory
            cp "$keystore_file" "$tmpkeys/"

            # Import with password piped to stdin
            echo "$password" | /home/user/nimbus-eth2/build/nimbus_beacon_node deposits import \
              --data-dir=/validator-data \
              "$tmpkeys"

            # Remove the keystore from tmpkeys for next iteration
            rm "$tmpkeys/$filename"

            IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
            echo "Successfully imported $filename"
          done

          # Cleanup
          rm -rf "$tmpkeys"
          rm -rf /validator-data/keystore-source

          echo "=== Nimbus test import completed: $IMPORTED_COUNT keystores imported ==="
          echo "Validator directory contents:"
          ls -laR /validator-data/validators/ || echo "No validators directory yet"
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

  containers:
    # Test Lodestar startup with the imported keystores
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "lodestar" }}
    - name: test-lodestar
      image: {{ .Values.validatorClient.image.repository | default "chainsafe/lodestar" }}:{{ .Values.validatorClient.image.tag | default "v1.35.0" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "Testing Lodestar with persisted keys backend..."

          # Start Lodestar (will timeout after 30s, which is fine)
          timeout 30s node /usr/app/packages/cli/bin/lodestar validator \
            --dataDir=/validator-data \
            --keystoresDir=/validator-data/keystores \
            --secretsDir=/validator-data/secrets \
            --beaconNodes=https://ethereum-beacon-api.publicnode.com \
            --network=mainnet \
            --distributed 2>&1 | tee /tmp/log || true

          # Verify keystores were loaded
          if grep -qi "local keystores imported\|local keystores" /tmp/log && \
             ! grep -qi "invalid password\|decrypt.*fail" /tmp/log; then
            echo "✓ SUCCESS: Lodestar loaded keystores with per-keystore passwords"
            exit 0
          fi

          echo "✗ FAIL: Keystore loading failed"
          cat /tmp/log
          exit 1
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

    # Test Prysm startup with the imported keystores
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "prysm" }}
    - name: test-prysm
      image: {{ .Values.validatorClient.image.repository | default "gcr.io/prysmaticlabs/prysm/validator" }}:{{ .Values.validatorClient.image.tag | default "v6.1.2" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "Testing Prysm with wallet..."

          # Start Prysm validator (will timeout after 30s, which is fine)
          timeout 30s /app/cmd/validator/validator \
            --wallet-dir=/validator-data/wallet \
            --wallet-password-file=/validator-data/wallet-password.txt \
            --beacon-rest-api-provider=https://ethereum-beacon-api.publicnode.com \
            --enable-beacon-rest-api \
            --accept-terms-of-use \
            --mainnet \
            --distributed 2>&1 | tee /tmp/log || true

          # Verify wallet was loaded (check for expected log messages)
          if cat /tmp/log | grep -i "Opened validator wallet" && \
             cat /tmp/log | grep -i "Waiting for deposit"; then
            echo "✓ SUCCESS: Prysm loaded wallet with per-keystore passwords"
            exit 0
          fi

          echo "✗ FAIL: Wallet loading failed"
          cat /tmp/log
          exit 1
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

    # Test Nimbus startup with the imported keystores
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "nimbus" }}
    - name: test-nimbus
      image: {{ .Values.validatorClient.image.repository | default "statusim/nimbus-validator-client" }}:{{ .Values.validatorClient.image.tag | default "multiarch-v25.9.2" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "Testing Nimbus with imported validators..."

          # Start Nimbus validator (will timeout after 30s, which is fine)
          timeout 30s /home/user/nimbus_validator_client \
            --beacon-node=https://ethereum-beacon-api.publicnode.com \
            --data-dir=/validator-data \
            --graffiti="test" \
            --distributed 2>&1 | tee /tmp/log || true

          # Verify validators were loaded
          if grep -qi "local validator attached\|loading.*validator" /tmp/log && \
             ! grep -qi "Failed to decrypt.*keystore\|password.*incorrect\|could not decrypt" /tmp/log; then
            echo "✓ SUCCESS: Nimbus loaded validators with per-keystore passwords"
            exit 0
          fi

          echo "✗ FAIL: Validator loading failed"
          cat /tmp/log
          exit 1
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

  volumes:
    - name: charon-data
      emptyDir: {}
    - name: validator-data
      emptyDir: {}
{{- end }}
