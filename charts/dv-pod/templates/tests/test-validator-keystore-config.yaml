{{- if .Values.tests.validatorKeystore.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "dv-pod.fullname" . }}-test-vc-keystore
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "dv-pod.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    test-scenario: validator-keystore-config
spec:
  restartPolicy: Never
  initContainers:
    # Generate real keystores using Charon
    - name: generate-keystores
      image: obolnetwork/charon:v1.7.0
      command: ["charon", "create", "cluster",
                "--cluster-dir=/charon-output",
                "--num-validators={{ .Values.tests.validatorKeystore.mockKeystoreCount }}",
                "--nodes=3", "--network=holesky",
                "--withdrawal-addresses=0x0000000000000000000000000000000000000000",
                "--fee-recipient-addresses=0x0000000000000000000000000000000000000000",
                "--insecure-keys"]
      volumeMounts:
        - name: charon-data
          mountPath: /charon-output

    # Prepare validator data directory with correct ownership
    # This matches statefulset.yaml's prepare-validator-data init container
    - name: prepare-validator-data
      image: busybox:1.37.0
      securityContext:
        runAsUser: 0
        runAsGroup: 0
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Preparing validator data directory..."
          mkdir -p /validator-data
          chown -R 1000:1000 /validator-data
          echo "Directory prepared with correct ownership"
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data

    # ⚠️  MAINTAINER WARNING: This init container MUST mirror the production logic from:
    #     charts/dv-pod/templates/statefulset.yaml (import-keystores init container, lines ~158-336)
    #
    # WHY: This test validates the ACTUAL production keystore import logic used in statefulset.yaml.
    #      The entire case statement and all validator client implementations must stay synchronized.
    #
    # WHAT TO SYNC: The complete shell script logic inside the args section, including:
    #               - All case statement branches (lodestar, prysm, lighthouse, etc.)
    #               - Directory structures, file operations, and permissions
    #               - Error handling and validation logic
    #
    # WHEN UPDATING: ANY changes to the import-keystores init container in statefulset.yaml
    #                MUST be replicated here to ensure tests validate real production behavior.
    #
    # SOURCE OF TRUTH: charts/dv-pod/templates/statefulset.yaml (import-keystores init container)
    #
    - name: import-keystores
      image: busybox:1.37.0
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          KEYSTORE_DIR="/charon-output/node0/validator_keys"
          VC_TYPE="{{ .Values.tests.validatorKeystore.validatorClientType }}"

          case "$VC_TYPE" in
            "lodestar")
              echo "Importing for Lodestar (persisted keys backend)..."
              mkdir -p /validator-data/keystores /validator-data/secrets

              IMPORTED_COUNT=0
              for f in $KEYSTORE_DIR/keystore-*.json; do
                [ -f "$f" ] || continue
                PUBKEY="0x$(grep '"pubkey"' "$f" | awk -F'"' '{print $4}')"
                [ -n "$PUBKEY" ] && [ "$PUBKEY" != "0x" ] || continue

                PUBKEY_DIR="/validator-data/keystores/$PUBKEY"
                mkdir -p "$PUBKEY_DIR"
                cp "$f" "$PUBKEY_DIR/voting-keystore.json"
                chmod 400 "$PUBKEY_DIR/voting-keystore.json"

                PASSWORD_FILE="${f%.json}.txt"
                if [ -f "$PASSWORD_FILE" ]; then
                  cp "$PASSWORD_FILE" "/validator-data/secrets/$PUBKEY"
                  chmod 600 "/validator-data/secrets/$PUBKEY"
                  IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
                fi
              done

              echo "Imported $IMPORTED_COUNT keystores"
              ;;
            "prysm")
              echo "Importing for Prysm (following Obol reference implementation)..."
              # Prysm requires wallet creation and per-keystore import
              # Reference: https://github.com/ObolNetwork/charon-distributed-validator-node/blob/main/prysm/run.sh

              # Just copy keystores to temporary location for now
              # The actual import will be done in a separate Prysm init container
              mkdir -p /validator-data/keystore-source
              cp -v $KEYSTORE_DIR/keystore-*.json /validator-data/keystore-source/ 2>/dev/null || echo "No keystore JSON files found"
              cp -v $KEYSTORE_DIR/keystore-*.txt /validator-data/keystore-source/ 2>/dev/null || echo "No keystore password files found"
              chmod -R 400 /validator-data/keystore-source/*.json 2>/dev/null || true
              chmod -R 600 /validator-data/keystore-source/*.txt 2>/dev/null || true

              echo "Keystores copied. Prysm wallet creation and import will be done in next init container"
              ;;
            *)
              echo "ERROR: Validator client type $VC_TYPE not implemented"
              exit 1
              ;;
          esac
      volumeMounts:
        - name: charon-data
          mountPath: /charon-output
          readOnly: true
        - name: validator-data
          mountPath: /validator-data

    # Prysm wallet creation and import (only runs for Prysm tests)
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "prysm" }}
    - name: prysm-wallet-import
      image: {{ .Values.validatorClient.image.repository | default "gcr.io/prysmaticlabs/prysm/validator" }}:{{ .Values.validatorClient.image.tag | default "v6.0.4" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "=== Prysm Test: Wallet Creation and Keystore Import ==="

          # Generate wallet password
          WALLET_PASSWORD="test-wallet-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)"
          echo "$WALLET_PASSWORD" > /validator-data/wallet-password.txt
          chmod 600 /validator-data/wallet-password.txt

          echo "Creating Prysm wallet..."
          /app/cmd/validator/validator wallet create \
            --wallet-dir=/validator-data/wallet \
            --wallet-password-file=/validator-data/wallet-password.txt \
            --keymanager-kind=direct \
            --accept-terms-of-use

          echo "Wallet created successfully"

          # Import keystores one at a time
          mkdir -p /tmp/tmpkeys
          IMPORTED_COUNT=0
          for keystore_file in /validator-data/keystore-source/keystore-*.json; do
            [ -f "$keystore_file" ] || continue

            echo "Importing keystore: $(basename $keystore_file)"
            cp "$keystore_file" /tmp/tmpkeys/

            password_file="${keystore_file%.json}.txt"
            if [ ! -f "$password_file" ]; then
              echo "ERROR: Password file not found: $password_file"
              exit 1
            fi

            /app/cmd/validator/validator accounts import \
              --wallet-dir=/validator-data/wallet \
              --keys-dir=/tmp/tmpkeys \
              --account-password-file="$password_file" \
              --wallet-password-file=/validator-data/wallet-password.txt \
              --accept-terms-of-use

            rm /tmp/tmpkeys/$(basename "$keystore_file")
            IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
            echo "Successfully imported $(basename $keystore_file)"
          done

          rm -rf /tmp/tmpkeys
          echo "=== Prysm test import completed: $IMPORTED_COUNT keystores imported ==="
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

  containers:
    # Test Lodestar startup with the imported keystores
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "lodestar" }}
    - name: test-lodestar
      image: {{ .Values.validatorClient.image.repository | default "chainsafe/lodestar" }}:{{ .Values.validatorClient.image.tag | default "v1.33.0" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "Testing Lodestar with persisted keys backend..."

          # Start Lodestar (will timeout after 30s, which is fine)
          timeout 30s node /usr/app/packages/cli/bin/lodestar validator \
            --dataDir=/validator-data \
            --keystoresDir=/validator-data/keystores \
            --secretsDir=/validator-data/secrets \
            --beaconNodes=https://ethereum-beacon-api.publicnode.com \
            --network=mainnet \
            --distributed 2>&1 | tee /tmp/log || true

          # Verify keystores were loaded
          if grep -qi "local keystores imported\|local keystores" /tmp/log && \
             ! grep -qi "invalid password\|decrypt.*fail" /tmp/log; then
            echo "✓ SUCCESS: Lodestar loaded keystores with per-keystore passwords"
            exit 0
          fi

          echo "✗ FAIL: Keystore loading failed"
          cat /tmp/log
          exit 1
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

    # Test Prysm startup with the imported keystores
    {{- if eq .Values.tests.validatorKeystore.validatorClientType "prysm" }}
    - name: test-prysm
      image: {{ .Values.validatorClient.image.repository | default "gcr.io/prysmaticlabs/prysm/validator" }}:{{ .Values.validatorClient.image.tag | default "v6.0.4" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "Testing Prysm with wallet..."

          # Start Prysm validator (will timeout after 30s, which is fine)
          timeout 30s /app/cmd/validator/validator \
            --wallet-dir=/validator-data/wallet \
            --wallet-password-file=/validator-data/wallet-password.txt \
            --beacon-rest-api-provider=https://ethereum-beacon-api.publicnode.com \
            --enable-beacon-rest-api \
            --accept-terms-of-use \
            --mainnet \
            --distributed 2>&1 | tee /tmp/log || true

          # Verify wallet was loaded (check for expected log messages)
          if cat /tmp/log | grep -i "Opened validator wallet" && \
             cat /tmp/log | grep -i "Waiting for deposit"; then
            echo "✓ SUCCESS: Prysm loaded wallet with per-keystore passwords"
            exit 0
          fi

          echo "✗ FAIL: Wallet loading failed"
          cat /tmp/log
          exit 1
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data
    {{- end }}

  volumes:
    - name: charon-data
      emptyDir: {}
    - name: validator-data
      emptyDir: {}
{{- end }}
