{{- if .Values.tests.validatorKeystore.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: {{ include "dv-pod.fullname" . }}-test-vc-keystore
  namespace: {{ .Release.Namespace }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  labels:
    {{- include "dv-pod.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
    test-scenario: validator-keystore-config
spec:
  restartPolicy: Never
  initContainers:
    # Generate real keystores using Charon
    - name: generate-keystores
      image: obolnetwork/charon:v1.7.0
      command: ["charon", "create", "cluster",
                "--cluster-dir=/charon-output",
                "--num-validators={{ .Values.tests.validatorKeystore.mockKeystoreCount }}",
                "--nodes=3", "--network=holesky",
                "--withdrawal-addresses=0x0000000000000000000000000000000000000000",
                "--fee-recipient-addresses=0x0000000000000000000000000000000000000000",
                "--insecure-keys"]
      volumeMounts:
        - name: charon-data
          mountPath: /charon-output

    # Run the ACTUAL init container import logic from the statefulset
    - name: import-keystores
      image: busybox:1.37.0
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          KEYSTORE_DIR="/charon-output/node0/validator_keys"
          VC_TYPE="{{ .Values.tests.validatorKeystore.validatorClientType }}"

          case "$VC_TYPE" in
            "lodestar")
              echo "Importing for Lodestar (persisted keys backend)..."
              mkdir -p /validator-data/keystores /validator-data/secrets

              IMPORTED_COUNT=0
              for f in $KEYSTORE_DIR/keystore-*.json; do
                [ -f "$f" ] || continue
                PUBKEY="0x$(grep '"pubkey"' "$f" | awk -F'"' '{print $4}')"
                [ -n "$PUBKEY" ] && [ "$PUBKEY" != "0x" ] || continue

                PUBKEY_DIR="/validator-data/keystores/$PUBKEY"
                mkdir -p "$PUBKEY_DIR"
                cp "$f" "$PUBKEY_DIR/voting-keystore.json"
                chmod 400 "$PUBKEY_DIR/voting-keystore.json"

                PASSWORD_FILE="${f%.json}.txt"
                if [ -f "$PASSWORD_FILE" ]; then
                  cp "$PASSWORD_FILE" "/validator-data/secrets/$PUBKEY"
                  chmod 600 "/validator-data/secrets/$PUBKEY"
                  IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
                fi
              done

              echo "Imported $IMPORTED_COUNT keystores"
              ;;
            *)
              echo "ERROR: Validator client type $VC_TYPE not implemented"
              exit 1
              ;;
          esac
      volumeMounts:
        - name: charon-data
          mountPath: /charon-output
          readOnly: true
        - name: validator-data
          mountPath: /validator-data

    # Set permissions for Lodestar
    - name: prepare-permissions
      image: busybox:1.37.0
      securityContext:
        runAsUser: 0
      command: ["/bin/sh", "-c", "chown -R 1000:1000 /validator-data && find /validator-data -type d -exec chmod 755 {} \\;"]
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data

  containers:
    # Test Lodestar startup with the imported keystores
    - name: test-lodestar
      {{- if eq .Values.tests.validatorKeystore.validatorClientType "lodestar" }}
      image: {{ .Values.validatorClient.image.repository | default "chainsafe/lodestar" }}:{{ .Values.validatorClient.image.tag | default "v1.33.0" }}
      command: ["/bin/sh", "-c"]
      args:
        - |
          set -e
          echo "Testing Lodestar with persisted keys backend..."

          # Start Lodestar (will timeout after 30s, which is fine)
          timeout 30s node /usr/app/packages/cli/bin/lodestar validator \
            --dataDir=/validator-data \
            --keystoresDir=/validator-data/keystores \
            --secretsDir=/validator-data/secrets \
            --beaconNodes=https://ethereum-beacon-api.publicnode.com \
            --network=mainnet \
            --distributed 2>&1 | tee /tmp/log || true

          # Verify keystores were loaded
          if grep -qi "local keystores imported\|local keystores" /tmp/log && \
             ! grep -qi "invalid password\|decrypt.*fail" /tmp/log; then
            echo "✓ SUCCESS: Lodestar loaded keystores with per-keystore passwords"
            exit 0
          fi

          echo "✗ FAIL: Keystore loading failed"
          cat /tmp/log
          exit 1
      {{- end }}
      volumeMounts:
        - name: validator-data
          mountPath: /validator-data

  volumes:
    - name: charon-data
      emptyDir: {}
    - name: validator-data
      emptyDir: {}
{{- end }}
