# Example values for deploying Prysm consensus client on Sepolia
# This is designed for use with the ethpandaops/prysm Helm chart
#
# Installation:
#   helm repo add ethpandaops https://ethpandaops.github.io/ethereum-helm-charts
#   helm install prysm-sepolia ethpandaops/prysm -n l1 -f prysm-sepolia.yaml
#
# This Prysm instance will serve as the L1 consensus client for your Aztec sequencer

# Override the full name to ensure consistent service naming
# This ensures the service is accessible at prysm-sepolia.l1.svc.cluster.local
fullnameOverride: prysm-sepolia

# Number of Prysm replicas (typically 1 for a single sequencer)
replicas: 1

# Container image
image:
  repository: gcr.io/prysmaticlabs/prysm/beacon-chain
  tag: v6.1.4
  pullPolicy: IfNotPresent

# Port configuration
p2pPort: 13001       # P2P networking (TCP and UDP)
httpPort: 3500       # HTTP API (gRPC gateway) - used by Aztec
rpcPort: 4000        # gRPC RPC port
metricsPort: 8080    # Prometheus metrics

# JWT secret for Engine API authentication
# This MUST match the JWT used by your execution client (Geth)
# The same JWT is used in geth-sepolia.yaml
jwt: ecb22bc24e7d4061f7ed690ccd5846d7d73f5d2b9733267e12f56790398d908a

# Checkpoint sync configuration
# Using checkpoint sync significantly speeds up initial sync (minutes vs hours)
checkpointSync:
  enabled: true
  url: https://checkpoint-sync.sepolia.ethpandaops.io

# CRITICAL: Additional Prysm flags for Aztec blob support
# These flags are essential for proper blob/data column handling
extraArgs:
  # CRITICAL: Network flag - must be first
  - --sepolia

  # CRITICAL: Execution endpoint - points to Geth service
  - --execution-endpoint=http://geth-sepolia:8551

  # Subscribe to all attestation subnets for complete network visibility
  # Required for Aztec to fetch all blob sidecars
  - --subscribe-all-data-subnets

  # Store blobs organized by epoch for efficient retrieval
  # Required for Aztec blob API queries
  - --blob-storage-layout=by-epoch

  # Accept Prysm terms of use
  - --accept-terms-of-use=true

# Persistence configuration
persistence:
  enabled: true
  size: 800Gi
  storageClassName: local-path
  accessModes:
    - ReadWriteOnce

# Pin to specific node for local storage persistence
# IMPORTANT: Should be on same node as Geth for best performance
nodeSelector:
  kubernetes.io/hostname: silverfib

# Resource allocation
# Sepolia testnet minimum: 4-8 cores, 16 GB RAM
# Total Sepolia stack (Geth + Prysm) uses ~637GB as of 2025
resources:
  requests:
    cpu: 2000m      # 2 cores minimum
    memory: 16Gi    # 16GB required for beacon chain + blobs
  limits:
    cpu: 4000m      # 4 cores for optimal performance
    memory: 16Gi

# Probes
# CRITICAL: Prysm needs extended liveness probe delay
# Data column filesystem cache warm-up takes 5-6 minutes on startup
# Setting initialDelaySeconds to 600s prevents premature pod restarts
livenessProbe:
  enabled: true
  initialDelaySeconds: 600  # 10 minutes to allow data column warm-up
  periodSeconds: 120
  failureThreshold: 3

readinessProbe:
  enabled: true
  initialDelaySeconds: 10
  periodSeconds: 10
  failureThreshold: 3

# Service configuration
service:
  type: ClusterIP

# RBAC and ServiceAccount
serviceAccount:
  create: true

rbac:
  create: true

# Pod management
podManagementPolicy: OrderedReady
terminationGracePeriodSeconds: 300

# Security context
securityContext:
  fsGroup: 10001
  runAsUser: 10001
  runAsGroup: 10001
  runAsNonRoot: true

# Init container to fix permissions
initContainers:
  - name: init-chown-data
    image: busybox:1.34.0
    command: ["chown", "-R", "10001:10001", "/data"]
    securityContext:
      runAsUser: 0
      runAsNonRoot: false
    volumeMounts:
      - name: storage
        mountPath: /data
