# Prysm Keystore Import Implementation

## Overview

This document describes the Prysm validator keystore import implementation that supports **per-keystore unique passwords** generated by Charon DKG.

## Problem Statement

Charon DKG generates validator keystores where each keystore has a **unique password** (e.g., `keystore-0.json` uses password from `keystore-0.txt`, `keystore-1.json` uses password from `keystore-1.txt`).

Prysm's `accounts import` CLI only accepts a single `--account-password-file` flag, meaning it cannot import multiple keystores with different passwords in a single command.

## Solution

Import keystores **one at a time** using a temporary directory pattern, following the [Obol reference implementation](https://github.com/ObolNetwork/charon-distributed-validator-node/blob/main/prysm/run.sh).

## Implementation Architecture

### Init Container Chain

```
1. prepare-validator-data    → Creates /validator-data with ownership 1000:1000
2. import-keystores           → Copies keystores to /validator-data/keystore-source/
3. prysm-wallet-import        → Creates wallet, imports keystores one-by-one
4. validator-client container → Runs Prysm validator with wallet
```

### File Structure

```
/validator-data/
├── keystore-source/              # Temporary staging (created by import-keystores)
│   ├── keystore-0.json          # From Charon DKG
│   ├── keystore-0.txt           # Unique password for keystore-0
│   ├── keystore-1.json
│   └── keystore-1.txt           # Unique password for keystore-1
├── wallet/                       # Created by prysm-wallet-import
│   └── direct/
│       └── accounts/
│           └── all-accounts.keystore.json
└── wallet-password.txt           # Wallet password (generated)
```

## Init Container Details

### 1. prepare-validator-data

**Purpose:** Create validator data directory with correct ownership

**Runs as:** Root (user 0)

**Actions:**
```bash
mkdir -p /validator-data
chown -R 1000:1000 /validator-data
```

**Source:** `charts/dv-pod/templates/statefulset.yaml` lines 137-153

---

### 2. import-keystores (Prysm Case)

**Purpose:** Copy keystores from Charon DKG output to staging location

**Runs as:** User 1000

**Actions:**
```bash
mkdir -p /validator-data/keystore-source
cp $KEYSTORE_DIR/keystore-*.json /validator-data/keystore-source/
cp $KEYSTORE_DIR/keystore-*.txt /validator-data/keystore-source/
chmod -R 400 /validator-data/keystore-source/*.json
chmod -R 600 /validator-data/keystore-source/*.txt
```

**Source:** `charts/dv-pod/templates/statefulset.yaml` lines 292-306

---

### 3. prysm-wallet-import

**Purpose:** Create Prysm wallet and import keystores with per-keystore passwords

**Runs as:** Default Prysm image user

**Actions:**

#### Step 1: Check if wallet already exists
```bash
if [ -d "/validator-data/wallet" ] && [ -f "/validator-data/wallet/direct/accounts/all-accounts.keystore.json" ]; then
  echo "Wallet already exists, skipping import"
  exit 0
fi
```

#### Step 2: Generate wallet password
```bash
WALLET_PASSWORD="prysm-wallet-$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c 32)"
echo "$WALLET_PASSWORD" > /validator-data/wallet-password.txt
chmod 600 /validator-data/wallet-password.txt
```

#### Step 3: Create Prysm wallet
```bash
/app/cmd/validator/validator wallet create \
  --wallet-dir=/validator-data/wallet \
  --wallet-password-file=/validator-data/wallet-password.txt \
  --keymanager-kind=direct \
  --accept-terms-of-use
```

#### Step 4: Import keystores one at a time
```bash
mkdir -p /tmp/tmpkeys
IMPORTED_COUNT=0

for keystore_file in /validator-data/keystore-source/keystore-*.json; do
  [ -f "$keystore_file" ] || continue

  # Copy ONE keystore to temp directory
  cp "$keystore_file" /tmp/tmpkeys/

  # Get corresponding password file
  password_file="${keystore_file%.json}.txt"

  # Import with per-keystore password
  /app/cmd/validator/validator accounts import \
    --wallet-dir=/validator-data/wallet \
    --keys-dir=/tmp/tmpkeys \
    --account-password-file="$password_file" \
    --wallet-password-file=/validator-data/wallet-password.txt \
    --accept-terms-of-use

  # Remove from temp directory
  rm /tmp/tmpkeys/$(basename "$keystore_file")

  IMPORTED_COUNT=$((IMPORTED_COUNT + 1))
done

# Cleanup
rm -rf /tmp/tmpkeys
rm -rf /validator-data/keystore-source
```

**Source:** `charts/dv-pod/templates/statefulset.yaml` lines 340-428

---

## Validator Client Configuration

The Prysm validator container uses the wallet created by the init container:

```yaml
command:
  - /app/cmd/validator/validator
  - --wallet-dir=/validator-data/wallet
  - --wallet-password-file=/validator-data/wallet-password.txt
  - --beacon-rest-api-provider=http://localhost:3600
  - --enable-beacon-rest-api
  - --accept-terms-of-use
  - --datadir=/validator-data
  - --distributed
```

**Source:** `charts/dv-pod/templates/statefulset.yaml` lines 619-647

---

## Key Design Decisions

### 1. Per-Keystore Import Loop

**Decision:** Import keystores one at a time using a temporary directory

**Rationale:**
- Prysm CLI accepts only one `--account-password-file` per import command
- Cannot import multiple keystores with different passwords in single command
- Temporary directory ensures only one keystore is present during import

**Alternative Considered:** Pre-process keystores to use shared password
- **Rejected:** Would require decrypting and re-encrypting keystores (security risk)

### 2. Wallet Password Generation

**Decision:** Generate random wallet password at runtime

**Rationale:**
- Wallet password is separate from keystore passwords
- Random generation ensures uniqueness per pod
- Stored in `/validator-data/wallet-password.txt` for validator container

### 3. Cleanup Strategy

**Decision:** Delete `/validator-data/keystore-source/` after import

**Rationale:**
- Keystores are now in wallet, source files no longer needed
- Reduces disk usage
- Prevents confusion about which keystores are active

**Note:** Original keystores remain in `/charon-data/validator_keys/` for backup

---

## Testing

### Test Coverage

The test file `charts/dv-pod/templates/tests/test-validator-keystore-config.yaml` provides end-to-end validation:

**Test Flow:**
1. **generate-keystores** - Uses Charon to create real DKG keystores with unique passwords
2. **prepare-validator-data** - Creates directory with correct ownership
3. **import-keystores** - Copies keystores to staging location (mirrors production)
4. **prysm-wallet-import** - Creates wallet and imports keystores
5. **test-prysm** - Starts Prysm validator and validates wallet loaded

**Success Criteria:**
- Prysm logs show: `"Opened validator wallet"`
- Prysm logs show: `"Waiting for deposit"`
- No password or decryption errors

### Manual Testing

To test manually:

```bash
# Install with Prysm validator
helm upgrade --install test-prysm charts/dv-pod \
  --set charon.operatorAddress=0x1234567890123456789012345678901234567890 \
  --set validatorClient.enabled=true \
  --set validatorClient.type=prysm \
  --set validatorClient.config.prysm.acceptTermsOfUse=true \
  --set tests.validatorKeystore.enabled=true \
  --set tests.validatorKeystore.validatorClientType=prysm \
  --set tests.validatorKeystore.mockKeystoreCount=2

# Run test
helm test test-prysm

# Check test results
kubectl logs test-prysm-dv-pod-test-vc-keystore -c test-prysm
```

---

## Troubleshooting

### Problem: "Could not decrypt keystore"

**Cause:** Password mismatch between keystore and password file

**Check:**
```bash
# Verify password files exist
kubectl exec -it <pod> -c prysm-wallet-import -- ls -la /validator-data/keystore-source/

# Expected:
# keystore-0.json
# keystore-0.txt  (password for keystore-0.json)
# keystore-1.json
# keystore-1.txt  (password for keystore-1.json)
```

**Solution:** Ensure `import-keystores` copied both JSON and TXT files

---

### Problem: "Permission denied" writing to /validator-data

**Cause:** Ownership not set correctly

**Check:**
```bash
kubectl logs <pod> -c prepare-validator-data
# Should show: "Directory prepared with correct ownership"

kubectl exec -it <pod> -- ls -ld /validator-data
# Should show: drwxr-xr-x 2 1000 1000
```

**Solution:** Ensure `prepare-validator-data` init container runs successfully

---

### Problem: "Wallet already exists, skipping import"

**Cause:** PVC contains wallet from previous run

**Check:**
```bash
kubectl exec -it <pod> -- ls -la /validator-data/wallet/direct/accounts/
```

**Solution:**
- **If intentional:** Init container correctly detects existing wallet
- **If unexpected:** Delete PVC or pod to recreate: `kubectl delete pod <pod-name>`

---

### Problem: No keystores imported (IMPORTED_COUNT=0)

**Cause:** No keystores found in `/validator-data/keystore-source/`

**Check:**
```bash
kubectl logs <pod> -c import-keystores
# Should show: "Importing for Prysm..."
# Should show: "copied" messages

kubectl logs <pod> -c prysm-wallet-import
# Check: "No keystores found in /validator-data/keystore-source"
```

**Solution:** Verify Charon DKG generated keystores or keystores exist in mounted secret

---

## Security Considerations

### Password Storage

- **Keystore passwords:** Stored in `/validator-data/keystore-source/*.txt` (mode 600)
  - Deleted after import completes
  - Only accessible by user 1000 during import

- **Wallet password:** Stored in `/validator-data/wallet-password.txt` (mode 600)
  - Persists for validator container to use
  - Randomly generated per pod (32 alphanumeric characters)

### File Permissions

- **Keystores (.json):** Mode 400 (read-only)
- **Passwords (.txt):** Mode 600 (read-write by owner only)
- **Wallet directory:** Owned by user 1000

### Volume Security

- `/validator-data` uses PVC (persistent across pod restarts)
- `/charon-data` uses PVC or emptyDir depending on config
- Backup keystores remain in `/charon-data/validator_keys/`

---

## Maintenance

### Synchronization Requirements

The test file `test-validator-keystore-config.yaml` mirrors production logic. When updating `statefulset.yaml`, also update:

**Files to Update:**
1. `charts/dv-pod/templates/statefulset.yaml` - Production implementation
2. `charts/dv-pod/templates/tests/test-validator-keystore-config.yaml` - Test validation

**Sections to Synchronize:**
- `import-keystores` Prysm case (statefulset.yaml lines 292-306)
- `prysm-wallet-import` init container (statefulset.yaml lines 340-428)

**Warning:** Test file contains explicit maintainer warning (lines 49-63) to keep logic synchronized.

---

## References

- **Obol Reference Implementation:** https://github.com/ObolNetwork/charon-distributed-validator-node/blob/main/prysm/run.sh
- **Charon DKG Documentation:** https://docs.obol.tech/docs/charon/dkg
- **Prysm Validator CLI:** https://docs.prylabs.network/docs/wallet/nondeterministic
- **Issue #136:** Lodestar validator unable to import multiple Charon DKG keystores (same root cause)

---

## Related Work

This implementation is part of a broader effort to support per-keystore unique passwords:

- **PR #137:** Lodestar keystore import with persisted keys backend
- **Current Work:** Prysm keystore import with wallet-based approach
- **Future:** Lighthouse, Teku, Nimbus implementations (if needed)

Both Lodestar and Prysm implementations solve the same root cause: Charon DKG generates keystores with unique per-keystore passwords, requiring validators to support per-keystore password files rather than a single shared password.
