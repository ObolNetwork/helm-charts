# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Obol Network Helm Charts repository — Kubernetes deployment configurations for Obol's Distributed Validator Technology (DVT) infrastructure. Contains 8 Helm charts for Charon middleware, relay servers, validator pods, and supporting services.

## Charts

| Chart | Purpose |
|-------|---------|
| `charon` | Single-node Charon distributed validator middleware |
| `charon-cluster` | Multi-node Charon cluster (4 nodes default) |
| `charon-relay` | Libp2p relay for P2P communication |
| `dv-pod` | Complete distributed validator pod (Charon + validator client + auto-DKG) — most complex chart |
| `obol-app` | Generic chart for running any Docker image with Obol stack integration |
| `helios` | Ethereum light client with CRD (HeliosClient) |
| `aztec-node` | Aztec network node (Full Node, Sequencer, or Prover) |
| `openclaw` | OpenClaw gateway (agent runtime) |

## Development Commands

```bash
make init    # Install pre-commit hooks (helm-docs + helm-lint)
make lint    # Run chart-testing via Docker (quay.io/helmpack/chart-testing:v3.4.0)
make docs    # Regenerate chart READMEs via Docker (jnorwood/helm-docs:v1.14.2)
make clean   # Uninstall pre-commit hooks
```

Lint a single chart locally:
```bash
helm lint charts/<chart-name>
helm template <release-name> charts/<chart-name>
```

## CI/CD Behavior

- **On PR**: Pre-commit hooks run (helm-docs + helm-lint). Test workflow creates a kind cluster with MetalLB + Prometheus Operator, then lints/templates all charts. Charts in `.github/helm-ci-values/install-charts.txt` (charon-cluster, charon-relay) get full `helm install --wait`. All others get `--dry-run` only.
- **On Renovate PRs**: `version-bump.yml` auto-bumps chart versions based on appVersion delta (major→major, minor→minor, patch-only→minor), regenerates helm-docs and values.schema.json, and commits.
- **On merge to main**: `release.yml` publishes charts via chart-releaser with GPG signing.
- **Test values overrides**: `.github/helm-ci-values/values-<chart>.yaml`
- **Skip list**: `.github/helm-ci-values/skip-charts.txt` — charts skipped during lint CI

## Chart Architecture Patterns

### Common Template Structure
All Charon-based charts share:
- **StatefulSets/Deployments** with consistent security contexts (UID/GID 10001, `runAsNonRoot: true`)
- **RBAC**: ClusterRole for node discovery (`nodes` get/list/watch) + Role for service discovery (`services` get/list/watch)
- **ServiceMonitor** for Prometheus operator
- **ConfigMaps** that map `config.*` values to environment variables
- **Secrets** references for validator keys, ENR private keys, cluster locks
- **PodDisruptionBudgets** for HA
- **`_helpers.tpl`** with standard name/label/selector/serviceAccount helpers

### Port Conventions
- `3600` — HTTP/validator API
- `3610` — P2P (libp2p)
- `3620` — Monitoring (Prometheus metrics, liveness `/livez`, readiness `/readyz`)
- `6831` — Jaeger tracing

### Volume Mount Conventions
- `/charon/validator_keys/` — Validator keystores
- `/charon/charon-enr-private-key/` — ENR private key
- `/charon/cluster-lock/` — Cluster lock config

### Values File Conventions
- `config.*` — Application settings (mapped to env vars)
- `secrets.*` — Secret references
- `service.*` — Kubernetes service config
- `rbac.*` — RBAC toggles and rules
- `image.*` — Container image settings

## Documentation Generation

Chart READMEs are **auto-generated** by helm-docs from `values.yaml` comments. To document a value, use the `-- ` comment prefix in values.yaml. Never manually edit chart README.md files — run `make docs` instead.

## Schema Generation

Some charts have `values.schema.json` files generated by `helm-values-schema-json` (v2.3.1). These are regenerated automatically during Renovate version bumps. Manual generation:
```bash
schema --use-helm-docs --values charts/<chart>/values.yaml --output charts/<chart>/values.schema.json
```
