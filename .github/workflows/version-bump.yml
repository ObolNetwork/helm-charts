name: Auto Version Bump

on:
  pull_request:
    branches: [main]
    paths:
      - "charts/**/Chart.yaml"

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    # Only run on Renovate PRs
    if: github.actor == 'renovate[bot]' || github.actor == 'renovate'
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get changed Chart.yaml files
        id: changed
        run: |
          CHARTS=$(git diff --name-only origin/main...HEAD | grep 'Chart.yaml' | xargs -I{} dirname {} | sort -u)
          echo "charts<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHARTS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Bump chart versions
        id: bump
        run: |
          BUMPED=""
          for chart_dir in ${{ steps.changed.outputs.charts }}; do
            CHART_FILE="${chart_dir}/Chart.yaml"
            [ -f "$CHART_FILE" ] || continue

            # Get current and previous appVersion
            NEW_APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            OLD_APP_VERSION=$(git show origin/main:"$CHART_FILE" 2>/dev/null | grep '^appVersion:' | awk '{print $2}' | tr -d '"' || echo "")

            # Skip if appVersion didn't change or is new chart
            [ -z "$OLD_APP_VERSION" ] && continue
            [ "$NEW_APP_VERSION" = "$OLD_APP_VERSION" ] && continue

            # Parse versions (strip leading v if present)
            OLD_MAJOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f1)
            OLD_MINOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f2)
            NEW_MAJOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f1)
            NEW_MINOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f2)

            # Determine bump type based on appVersion change
            if [ "$NEW_MAJOR" != "$OLD_MAJOR" ]; then
              BUMP_TYPE="major"
            elif [ "$NEW_MINOR" != "$OLD_MINOR" ]; then
              BUMP_TYPE="minor"
            else
              BUMP_TYPE="patch"
            fi

            # Get current chart version
            CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            CHART_MAJOR=$(echo "$CHART_VERSION" | cut -d. -f1)
            CHART_MINOR=$(echo "$CHART_VERSION" | cut -d. -f2)
            CHART_PATCH=$(echo "$CHART_VERSION" | cut -d. -f3)

            # Calculate new chart version
            case "$BUMP_TYPE" in
              major)
                NEW_CHART_VERSION="$((CHART_MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_CHART_VERSION="${CHART_MAJOR}.$((CHART_MINOR + 1)).0"
                ;;
              patch)
                NEW_CHART_VERSION="${CHART_MAJOR}.${CHART_MINOR}.$((CHART_PATCH + 1))"
                ;;
            esac

            # Update Chart.yaml
            sed -i "s/^version: .*/version: ${NEW_CHART_VERSION}/" "$CHART_FILE"

            CHART_NAME=$(basename "$chart_dir")
            echo "Bumped $CHART_NAME: $CHART_VERSION -> $NEW_CHART_VERSION ($BUMP_TYPE, appVersion: $OLD_APP_VERSION -> $NEW_APP_VERSION)"
            BUMPED="${BUMPED}${CHART_NAME} "
          done

          echo "bumped=${BUMPED}" >> "$GITHUB_OUTPUT"

      - name: Install helm-docs
        if: steps.bump.outputs.bumped != ''
        run: |
          HELM_DOCS_VERSION="1.14.2"
          curl -fsSL "https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz" \
            | tar xz -C /usr/local/bin helm-docs

      - name: Regenerate helm-docs
        if: steps.bump.outputs.bumped != ''
        run: helm-docs --chart-search-root charts

      - name: Commit version bump
        if: steps.bump.outputs.bumped != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/*/Chart.yaml charts/*/README.md
          git diff --staged --quiet || git commit -m "chore: bump chart versions and regenerate docs"
          git push
