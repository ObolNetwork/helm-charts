name: Auto Version Bump

on:
  pull_request:
    branches: [main]
    paths:
      - "charts/**"

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    runs-on: ubuntu-latest
    # Only run on Renovate PRs
    if: github.actor == 'renovate[bot]' || github.actor == 'renovate'
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get changed chart directories
        id: changed
        run: |
          # Find all chart dirs with changes (any file, not just Chart.yaml)
          CHARTS=$(git diff --name-only origin/main...HEAD -- charts/ | sed 's|^\(charts/[^/]*\)/.*|\1|' | sort -u)
          echo "charts<<EOF" >> "$GITHUB_OUTPUT"
          echo "$CHARTS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Bump chart versions
        id: bump
        run: |
          BUMPED=""
          for chart_dir in ${{ steps.changed.outputs.charts }}; do
            CHART_FILE="${chart_dir}/Chart.yaml"
            [ -f "$CHART_FILE" ] || continue

            # Check if chart version was already bumped in this PR
            OLD_CHART_VERSION=$(git show origin/main:"$CHART_FILE" 2>/dev/null | grep '^version:' | awk '{print $2}' | tr -d '"' || echo "")
            CURRENT_CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            [ "$OLD_CHART_VERSION" != "$CURRENT_CHART_VERSION" ] && continue

            # Get current and previous appVersion
            NEW_APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | awk '{print $2}' | tr -d '"')
            OLD_APP_VERSION=$(git show origin/main:"$CHART_FILE" 2>/dev/null | grep '^appVersion:' | awk '{print $2}' | tr -d '"' || echo "")

            BUMP_TYPE="patch"
            if [ -n "$OLD_APP_VERSION" ] && [ "$NEW_APP_VERSION" != "$OLD_APP_VERSION" ]; then
              # appVersion changed — determine bump type from appVersion delta
              OLD_MAJOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f1)
              OLD_MINOR=$(echo "${OLD_APP_VERSION#v}" | cut -d. -f2)
              NEW_MAJOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f1)
              NEW_MINOR=$(echo "${NEW_APP_VERSION#v}" | cut -d. -f2)

              if [ "$NEW_MAJOR" != "$OLD_MAJOR" ]; then
                BUMP_TYPE="major"
              elif [ "$NEW_MINOR" != "$OLD_MINOR" ]; then
                BUMP_TYPE="minor"
              fi
            else
              # appVersion didn't change (e.g. validator client updates) → always minor
              BUMP_TYPE="minor"
            fi

            # Calculate new chart version
            CHART_MAJOR=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f1)
            CHART_MINOR=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f2)
            CHART_PATCH=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f3)

            case "$BUMP_TYPE" in
              major)
                NEW_CHART_VERSION="$((CHART_MAJOR + 1)).0.0"
                ;;
              minor)
                NEW_CHART_VERSION="${CHART_MAJOR}.$((CHART_MINOR + 1)).0"
                ;;
              patch)
                NEW_CHART_VERSION="${CHART_MAJOR}.${CHART_MINOR}.$((CHART_PATCH + 1))"
                ;;
            esac

            sed -i "s/^version: .*/version: ${NEW_CHART_VERSION}/" "$CHART_FILE"

            CHART_NAME=$(basename "$chart_dir")
            echo "Bumped $CHART_NAME: $CURRENT_CHART_VERSION -> $NEW_CHART_VERSION ($BUMP_TYPE)"
            BUMPED="${BUMPED}${CHART_NAME} "
          done

          echo "bumped=${BUMPED}" >> "$GITHUB_OUTPUT"

      - name: Install helm-docs
        if: steps.bump.outputs.bumped != ''
        run: |
          HELM_DOCS_VERSION="1.14.2"
          curl -fsSL "https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz" \
            | tar xz -C /usr/local/bin helm-docs

      - name: Install helm-values-schema-json
        if: steps.bump.outputs.bumped != ''
        run: |
          SCHEMA_VERSION="2.3.1"
          curl -fsSL "https://github.com/losisin/helm-values-schema-json/releases/download/v${SCHEMA_VERSION}/helm-values-schema-json_${SCHEMA_VERSION}_linux_amd64.tgz" \
            | tar xz -C /usr/local/bin schema

      - name: Regenerate helm-docs and schemas
        if: steps.bump.outputs.bumped != ''
        run: |
          helm-docs --chart-search-root charts
          for chart in charts/*/; do
            name=$(basename "$chart")
            echo "Generating schema for ${name}..."
            schema --use-helm-docs --values "${chart}values.yaml" --output "${chart}values.schema.json"
          done

      - name: Commit version bump
        if: steps.bump.outputs.bumped != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/*/Chart.yaml charts/*/README.md charts/*/values.schema.json
          git diff --staged --quiet || git commit -m "chore: bump chart versions and regenerate docs"
          git push
