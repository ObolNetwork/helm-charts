name: Bump Chart Version on Image Update

on:
  pull_request:
    paths:
      - 'charts/*/values.yaml'

jobs:
  bump-chart-version:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'renovate/')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Get changed charts
        id: changed
        run: |
          CHANGED_CHARTS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep 'charts/.*/values.yaml' | cut -d'/' -f2 | sort -u)
          echo "charts=$CHANGED_CHARTS" >> $GITHUB_OUTPUT

      - name: Bump chart versions
        run: |
          for chart in ${{ steps.changed.outputs.charts }}; do
            CHART_FILE="charts/${chart}/Chart.yaml"
            VALUES_FILE="charts/${chart}/values.yaml"

            if [[ ! -f "$CHART_FILE" ]]; then
              echo "Chart.yaml not found for $chart, skipping..."
              continue
            fi

            # Extract new image tag from values.yaml (handles both quoted and unquoted)
            NEW_TAG=$(grep -A1 '# -- Image tag' "$VALUES_FILE" | tail -1 | sed 's/.*tag:[[:space:]]*//' | tr -d '"' | tr -d "'" || true)

            if [[ -z "$NEW_TAG" ]]; then
              echo "Could not extract image tag for $chart, skipping..."
              continue
            fi

            echo "Detected new image tag for $chart: $NEW_TAG"

            # Update appVersion in Chart.yaml
            sed -i "s/^appVersion:.*/appVersion: \"$NEW_TAG\"/" "$CHART_FILE"

            # Bump patch version
            CURRENT_VERSION=$(grep '^version:' "$CHART_FILE" | sed 's/version:[[:space:]]*//')
            MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
            MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
            PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

            sed -i "s/^version:.*/version: $NEW_VERSION/" "$CHART_FILE"

            echo "Updated $chart: version $CURRENT_VERSION -> $NEW_VERSION, appVersion -> $NEW_TAG"
          done

      - name: Commit changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/*/Chart.yaml
          if git diff --staged --quiet; then
            echo "No Chart.yaml changes to commit"
          else
            git commit -m "chore: bump chart version for image update"
            git push
          fi
